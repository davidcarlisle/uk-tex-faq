<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Subverting a token register</title>
<link rel="stylesheet" href="faq.css">
</head>
<body>
<div class="breadcrumbs">
<a href="index.html">FAQ</a> &gt; <a href="index.html#Macroprogramming">Macro programming</a> &gt; <a href="index.html#ldquoGenericrdquomacrosandtechniques">&ldquo;Generic&rdquo; macros and techniques</a> &gt; <a href="index.html#Q-subverttoks">Subverting a token register</a>
</div>
<h1>Subverting a token register</h1>


<p>

<p>
A common requirement is to &ldquo;subvert&rdquo; a token register that other
macros may use.  The requirement arises when you want to add something
to a system token register (<code>&#x5c;output</code> or <code>&#x5c;every*</code>), but know
that other macros use the token register, too.  (A common requirement
is to work on <code>&#x5c;everypar</code>, but LaTeX changes <code>&#x5c;everypar</code> at
every touch and turn.)

<p>
The following technique, due to David Kastrup, does what you need, and
allows an independent package to play the exact same game:
<blockquote>
<pre>
\let\mypkg@@everypar\everypar
\newtoks\mypkg@everypar
\mypkg@everypar\expandafter{\the\everypar}
\mypkg@@everypar{\mypkgs@ownstuff\the\mypkg@everypar}
\def\mypkgs@ownstuff{%
  <stuff to do at the start of the token register>%
}
\let\everypar\mypkg@everypar
</pre>
<pre>
\let\mypkg@@everypar\everypar
\newtoks\mypkg@everypar
\mypkg@everypar\expandafter{\the\everypar}
\mypkg@@everypar{\mypkgs@ownstuff
                      \the\mypkg@everypar}
\def\mypkgs@ownstuff{%
  <stuff to do at the start of
                      the token register>%
}
\let\everypar\mypkg@everypar
</pre>
</blockquote>
As you can see, the package (<i class="package">mypkg</i>)
<ul>
<li> creates an alias for the existing &ldquo;system&rdquo; <code>&#x5c;everypar</code>
  (which is frozen into any surrounding environment, which will carry
  on using the original);
<li> creates a token register to subvert <code>&#x5c;everypar</code> and
  initialises it with the current contents of <code>&#x5c;everypar</code>;
<li> sets the &ldquo;old&rdquo; <code>&#x5c;everypar</code> to execute its own extra code,
  as well as the contents of its own token register;
<li> defines the macro for the extra code; and
<li> points the token <code>&#x5c;everypar</code> at the new token register.
</ul>
and away we go.

<p>
The form <code>&#x5c;mypkg@...</code> is (sort of) blessed for LaTeX package
internal names, which is why this example uses macros of that form.

<p>

<hr><p class="faqlink">This question on the Web: <a href="http://www.tex.ac.uk/cgi-bin/texfaq2html?label=subverttoks">http://www.tex.ac.uk/cgi-bin/texfaq2html?label=subverttoks</a></p>
